---
import AdminLayout2 from '../../layouts/AdminLayout2.astro';
import AdminPageHeader from '../../components/admin/AdminPageHeader.astro';
---

<AdminLayout2 title="Media Library" currentPage="media">
  <AdminPageHeader title="Media Library" description="Upload and manage images and videos">
    <label class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg cursor-pointer text-sm font-medium transition-colors">
      Upload File
      <input type="file" id="fileInput" class="hidden" accept="image/jpeg,image/png,image/gif,image/webp,image/svg+xml,image/avif,image/heic,image/heif,video/mp4,video/webm,video/quicktime,.jpg,.jpeg,.png,.gif,.webp,.svg,.avif,.heic,.heif,.mp4,.webm,.mov" multiple />
    </label>
  </AdminPageHeader>

  <!-- Upload Progress -->
  <div id="uploadProgress" class="hidden mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex items-center gap-3">
      <div class="animate-spin w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full"></div>
      <span class="text-blue-800 text-sm">Uploading...</span>
    </div>
  </div>

  <!-- Drag & Drop Area -->
  <div id="dropZone" class="mb-6 border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-white transition-colors hover:border-blue-400 hover:bg-blue-50/50">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400 mb-3">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
      <polyline points="17 8 12 3 7 8"></polyline>
      <line x1="12" y1="3" x2="12" y2="15"></line>
    </svg>
    <p class="text-sm text-gray-600">Drag and drop files here, or click "Upload File" above</p>
    <p class="text-xs text-gray-400 mt-1">Images (JPG, PNG, GIF, WebP, AVIF, HEIC) and videos (MP4, WebM)</p>
  </div>

  <!-- Media Grid -->
  <div id="mediaGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
    <p class="col-span-full text-gray-500 text-sm">Loading media...</p>
  </div>

  <!-- Preview Dialog -->
  <dialog id="preview-dialog" class="rounded-xl shadow-2xl backdrop:bg-black/60 p-0 w-full max-w-3xl border border-gray-200 animate-modal-in">
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
      <h3 id="previewTitle" class="text-lg font-semibold text-gray-900 truncate">File Preview</h3>
      <button type="button" id="previewCloseBtn" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-lg hover:bg-gray-100">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div id="previewContent" class="px-6 py-4 flex items-center justify-center min-h-[200px]"></div>
    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
      <div class="flex items-center gap-2 mb-3">
        <input type="text" id="previewUrl" readonly class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm text-gray-600" />
        <button type="button" id="copyUrlBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors whitespace-nowrap">Copy URL</button>
      </div>
      <div class="flex justify-end">
        <button type="button" id="deleteFileBtn" class="px-4 py-2 text-sm font-medium text-red-600 bg-white border border-red-300 rounded-lg hover:bg-red-50 transition-colors">Delete File</button>
      </div>
    </div>
  </dialog>

  <script is:inline>
    const MEDIA_API = '/api/cms/media';
    const MAX_FILE_SIZE = 4 * 1024 * 1024;
    let mediaFiles = [];
    let currentFile = null;

    document.addEventListener('DOMContentLoaded', loadMedia);

    // File input handler
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      await uploadFiles(e.target.files);
      e.target.value = '';
    });

    // Drag & drop
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-blue-500', 'bg-blue-50');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    });
    dropZone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-500', 'bg-blue-50');
      await uploadFiles(e.dataTransfer.files);
    });

    async function uploadFiles(files) {
      if (files.length === 0) return;
      const progress = document.getElementById('uploadProgress');
      progress.classList.remove('hidden');

      let uploaded = 0;
      for (const file of files) {
        if (file.size > MAX_FILE_SIZE) {
          showToast(`"${file.name}" is too large (${formatSize(file.size)}). Max is 4 MB.`, 'error');
          continue;
        }
        const formData = new FormData();
        formData.append('file', file);
        try {
          const res = await fetch(MEDIA_API, { method: 'POST', body: formData });
          if (!res.ok) throw new Error('Upload failed');
          uploaded++;
        } catch (error) {
          showToast('Error uploading ' + file.name + ': ' + error.message, 'error');
        }
      }

      progress.classList.add('hidden');
      if (uploaded > 0) {
        showToast(`Uploaded ${uploaded} file${uploaded > 1 ? 's' : ''}`, 'success');
        await loadMedia();
      }
    }

    async function loadMedia() {
      try {
        const res = await fetch(MEDIA_API);
        mediaFiles = await res.json();
        renderMedia();
      } catch (error) {
        document.getElementById('mediaGrid').innerHTML = '<p class="col-span-full text-red-500 text-sm">Error loading media</p>';
      }
    }

    function renderMedia() {
      const grid = document.getElementById('mediaGrid');
      if (mediaFiles.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full flex flex-col items-center justify-center py-16 text-center">
            <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center mb-4">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-gray-400"><path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2z"></path></svg>
            </div>
            <p class="text-sm text-gray-500">No media files yet. Upload some.</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = mediaFiles.map(file => `
        <button type="button" data-file-name="${escapeAttr(file.name)}"
          class="bg-white rounded-lg border border-gray-200 overflow-hidden hover:border-blue-300 hover:shadow-sm transition-all text-left group">
          <div class="aspect-square bg-gray-50 flex items-center justify-center overflow-hidden">
            ${file.type === 'video'
              ? `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-gray-400"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`
              : `<img src="${escapeAttr(file.url)}" alt="${escapeAttr(file.name)}" class="w-full h-full object-cover" loading="lazy" />`}
          </div>
          <div class="px-2 py-1.5">
            <p class="text-xs text-gray-700 truncate">${escapeHtml(file.name)}</p>
            <p class="text-xs text-gray-400">${formatSize(file.size)}</p>
          </div>
        </button>
      `).join('');
    }

    function escapeHtml(text) {
      if (!text) return '';
      const d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML;
    }
    function escapeAttr(text) {
      if (!text) return '';
      return text.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    function formatSize(bytes) {
      if (!bytes) return '0 B';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Preview dialog
    const previewDialog = document.getElementById('preview-dialog');

    document.getElementById('mediaGrid').addEventListener('click', (e) => {
      const btn = e.target.closest('[data-file-name]');
      if (!btn) return;
      const name = btn.dataset.fileName;
      currentFile = mediaFiles.find(f => f.name === name);
      if (!currentFile) return;

      document.getElementById('previewTitle').textContent = currentFile.name;
      document.getElementById('previewUrl').value = currentFile.url;
      const content = document.getElementById('previewContent');
      if (currentFile.type === 'video') {
        content.innerHTML = `<video src="${escapeAttr(currentFile.url)}" controls class="max-w-full max-h-80 rounded-lg"></video>`;
      } else {
        content.innerHTML = `<img src="${escapeAttr(currentFile.url)}" alt="${escapeAttr(currentFile.name)}" class="max-w-full max-h-80 rounded-lg" />`;
      }
      previewDialog.showModal();
    });

    document.getElementById('previewCloseBtn').addEventListener('click', () => previewDialog.close());
    previewDialog.addEventListener('click', (e) => { if (e.target === previewDialog) previewDialog.close(); });

    document.getElementById('copyUrlBtn').addEventListener('click', () => {
      navigator.clipboard.writeText(document.getElementById('previewUrl').value);
      showToast('URL copied to clipboard', 'success');
    });

    document.getElementById('deleteFileBtn').addEventListener('click', () => {
      if (!currentFile) return;
      showConfirm('confirm-dialog', async () => {
        try {
          const res = await fetch(MEDIA_API, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fileName: currentFile.name })
          });
          if (!res.ok) throw new Error('Delete failed');
          previewDialog.close();
          showToast('File deleted', 'success');
          await loadMedia();
        } catch (e) { showToast('Error: ' + e.message, 'error'); }
      }, { title: 'Delete File', message: `"${currentFile.name}" will be permanently deleted.` });
    });
  </script>
</AdminLayout2>
