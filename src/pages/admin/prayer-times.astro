---
import AdminLayout2 from '../../layouts/AdminLayout2.astro';
import AdminPageHeader from '../../components/admin/AdminPageHeader.astro';
---

<AdminLayout2 title="Prayer Times" currentPage="prayer-times">
  <AdminPageHeader title="Prayer Times" description="Manage daily prayer times for the entire year">
    <button id="saveAllBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
      Save Month
    </button>
  </AdminPageHeader>

  <!-- Month Selector -->
  <div class="flex gap-1 mb-6 flex-wrap">
    <button data-month="1" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 transition-colors">Jan</button>
    <button data-month="2" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Feb</button>
    <button data-month="3" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Mar</button>
    <button data-month="4" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Apr</button>
    <button data-month="5" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">May</button>
    <button data-month="6" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Jun</button>
    <button data-month="7" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Jul</button>
    <button data-month="8" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Aug</button>
    <button data-month="9" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Sep</button>
    <button data-month="10" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Oct</button>
    <button data-month="11" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Nov</button>
    <button data-month="12" class="month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Dec</button>
  </div>

  <!-- Prayer Times Table -->
  <div class="overflow-x-auto bg-white rounded-lg border border-gray-200">
    <div id="tableContainer">
      <p class="text-gray-500 text-sm p-6">Loading...</p>
    </div>
  </div>

  <script is:inline>
    const API_URL = '/api/cms/prayer-times';
    let currentMonth = 1;
    let items = [];
    let editedRows = {};

    const MONTH_NAMES = ['', 'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];
    const DAYS_IN_MONTH = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

    const PRAYER_FIELDS = [
      { key: 'fajrBegins', label: 'Fajr' },
      { key: 'fajrJamah', label: 'F.Jam' },
      { key: 'sunrise', label: 'Sunrise' },
      { key: 'zuhrBegins', label: 'Zuhr' },
      { key: 'zuhrJamah', label: 'Z.Jam' },
      { key: 'asrBegins', label: 'Asr' },
      { key: 'asrJamah', label: 'A.Jam' },
      { key: 'maghribBegins', label: 'Magh' },
      { key: 'maghribJamah', label: 'M.Jam' },
      { key: 'ishaBegins', label: 'Isha' },
      { key: 'ishaJamah', label: 'I.Jam' },
    ];

    document.addEventListener('DOMContentLoaded', () => {
      loadMonth(1);

      document.querySelectorAll('.month-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const month = parseInt(btn.dataset.month);
          currentMonth = month;
          document.querySelectorAll('.month-btn').forEach(b => {
            b.className = 'month-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors';
          });
          btn.className = 'month-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 transition-colors';
          loadMonth(month);
        });
      });

      document.getElementById('saveAllBtn').addEventListener('click', saveAll);
    });

    async function loadMonth(month) {
      editedRows = {};
      try {
        const response = await fetch(API_URL + '?month=' + month);
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Unknown error');
        }
        items = await response.json();
        renderTable();
      } catch (error) {
        console.error('Error loading prayer times:', error);
        document.getElementById('tableContainer').innerHTML = `
          <div class="p-6">
            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
              <h3 class="font-semibold text-red-800 mb-2">Could not load prayer times</h3>
              <p class="text-red-600 text-sm">Please check your database connection and try again.</p>
              <button onclick="loadMonth(currentMonth)" class="mt-3 text-sm font-medium text-red-700 hover:text-red-800">Retry</button>
            </div>
          </div>
        `;
      }
    }

    function renderTable() {
      const container = document.getElementById('tableContainer');
      const daysInMonth = DAYS_IN_MONTH[currentMonth];

      const byDay = {};
      items.forEach(item => { byDay[item.day] = item; });

      let html = `
        <table class="w-full text-xs">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="px-3 py-2.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider sticky left-0 bg-white z-10">Day</th>
              ${PRAYER_FIELDS.map(f => `<th class="px-1 py-2.5 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider whitespace-nowrap">${f.label}</th>`).join('')}
              <th class="px-2 py-2.5 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider w-10"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
      `;

      for (let day = 1; day <= daysInMonth; day++) {
        const existing = byDay[day];
        const rowBg = existing ? '' : 'bg-amber-50/50';
        const altBg = day % 2 === 0 ? 'bg-gray-50/50' : '';

        html += `<tr class="${existing ? altBg : rowBg}" data-day="${day}">`;
        html += `<td class="px-3 py-1 font-medium text-gray-700 sticky left-0 bg-white z-10 whitespace-nowrap text-xs">${day}</td>`;

        PRAYER_FIELDS.forEach(f => {
          const value = existing ? (existing[f.key] || '') : '';
          html += `<td class="px-0 py-0">
            <input type="text" data-day="${day}" data-field="${f.key}"
              value="${escapeAttr(value)}"
              class="w-full px-1 py-1 text-center text-xs border-0 bg-transparent focus:ring-1 focus:ring-blue-500 focus:bg-white focus:outline-none"
              style="min-width: 60px;"
              onchange="markEdited(${day})" />
          </td>`;
        });

        html += `<td class="px-1 py-1 text-center">
          ${existing ? `<button onclick="deleteRow('${existing.id}')" class="p-1 rounded text-gray-300 hover:text-red-500 hover:bg-red-50 transition-colors" title="Delete">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path></svg>
          </button>` : ''}
        </td>`;
        html += `</tr>`;
      }

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function escapeAttr(text) {
      if (!text) return '';
      return text.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    window.markEdited = function(day) {
      editedRows[day] = true;
      const row = document.querySelector(`tr[data-day="${day}"]`);
      if (row) {
        row.classList.remove('bg-gray-50/50');
        row.classList.add('bg-blue-50/50');
      }
    };

    async function saveAll() {
      const editedDays = Object.keys(editedRows).map(Number);
      if (editedDays.length === 0) {
        showToast('No changes to save.', 'info');
        return;
      }

      const records = [];
      for (const day of editedDays) {
        const row = { month: currentMonth, day };
        let hasData = false;
        PRAYER_FIELDS.forEach(f => {
          const input = document.querySelector(`input[data-day="${day}"][data-field="${f.key}"]`);
          const val = input ? input.value.trim() : '';
          row[f.key] = val;
          if (val) hasData = true;
        });
        if (hasData) records.push(row);
      }

      if (records.length === 0) {
        showToast('No valid data to save.', 'warning');
        return;
      }

      const btn = document.getElementById('saveAllBtn');
      btn.textContent = 'Saving...';
      btn.disabled = true;

      try {
        const res = await fetch(API_URL + '?bulk=true', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(records)
        });
        if (!res.ok) throw new Error('Failed to save');
        const result = await res.json();
        showToast(`Saved ${result.count} prayer time(s)`, 'success');
        editedRows = {};
        await loadMonth(currentMonth);
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      } finally {
        btn.textContent = 'Save Month';
        btn.disabled = false;
      }
    }

    window.deleteRow = function(id) {
      showConfirm('confirm-dialog', async () => {
        try {
          const res = await fetch(API_URL, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
          });
          if (!res.ok) throw new Error('Failed to delete');
          showToast('Entry deleted', 'success');
          await loadMonth(currentMonth);
        } catch (e) { showToast('Error: ' + e.message, 'error'); }
      }, { title: 'Delete Entry', message: 'This prayer time entry will be removed.' });
    };
  </script>
</AdminLayout2>
