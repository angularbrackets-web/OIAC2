---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Prayer Times" currentPage="prayer-times">
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Prayer Times</h1>
      <p class="text-gray-600 mt-1">Manage daily prayer times for the entire year</p>
    </div>
    <div class="flex gap-2">
      <button id="seedBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-medium text-sm">
        Seed from Files
      </button>
      <button id="saveAllBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
        Save Month
      </button>
    </div>
  </div>

  <!-- Month Selector -->
  <div class="flex gap-1 mb-6 flex-wrap">
    <button data-month="1" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-blue-600 text-white">Jan</button>
    <button data-month="2" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">Feb</button>
    <button data-month="3" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">Mar</button>
    <button data-month="4" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">Apr</button>
    <button data-month="5" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">May</button>
    <button data-month="6" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">Jun</button>
    <button data-month="7" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">Jul</button>
    <button data-month="8" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">Aug</button>
    <button data-month="9" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">Sep</button>
    <button data-month="10" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">Oct</button>
    <button data-month="11" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">Nov</button>
    <button data-month="12" class="month-btn px-3 py-2 rounded-lg font-medium text-sm bg-gray-200 text-gray-700">Dec</button>
  </div>

  <!-- Status -->
  <div id="statusMsg" class="hidden mb-4 p-3 rounded text-sm"></div>

  <!-- Prayer Times Table -->
  <div class="overflow-x-auto">
    <div id="tableContainer">
      <p class="text-gray-500">Loading...</p>
    </div>
  </div>

  <script is:inline>
    const API_URL = '/api/cms/prayer-times';
    let currentMonth = 1;
    let items = [];
    let editedRows = {};

    const MONTH_NAMES = ['', 'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];
    const DAYS_IN_MONTH = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

    const PRAYER_FIELDS = [
      { key: 'fajrBegins', label: 'Fajr' },
      { key: 'fajrJamah', label: 'F.Jam' },
      { key: 'sunrise', label: 'Sunrise' },
      { key: 'zuhrBegins', label: 'Zuhr' },
      { key: 'zuhrJamah', label: 'Z.Jam' },
      { key: 'asrBegins', label: 'Asr' },
      { key: 'asrJamah', label: 'A.Jam' },
      { key: 'maghribBegins', label: 'Magh' },
      { key: 'maghribJamah', label: 'M.Jam' },
      { key: 'ishaBegins', label: 'Isha' },
      { key: 'ishaJamah', label: 'I.Jam' },
    ];

    document.addEventListener('DOMContentLoaded', () => {
      loadMonth(1);

      document.querySelectorAll('.month-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const month = parseInt(btn.dataset.month);
          currentMonth = month;
          document.querySelectorAll('.month-btn').forEach(b => {
            b.classList.remove('bg-blue-600', 'text-white');
            b.classList.add('bg-gray-200', 'text-gray-700');
          });
          btn.classList.remove('bg-gray-200', 'text-gray-700');
          btn.classList.add('bg-blue-600', 'text-white');
          loadMonth(month);
        });
      });

      document.getElementById('saveAllBtn').addEventListener('click', saveAll);
      document.getElementById('seedBtn').addEventListener('click', seedFromFiles);
    });

    async function loadMonth(month) {
      editedRows = {};
      try {
        const response = await fetch(API_URL + '?month=' + month);
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Unknown error');
        }
        items = await response.json();
        renderTable();
      } catch (error) {
        console.error('Error loading prayer times:', error);
        document.getElementById('tableContainer').innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-6">
            <h3 class="font-semibold text-red-800 mb-2">Could not load prayer times</h3>
            <p class="text-red-600 text-sm mb-3">
              The <code class="bg-red-100 px-1 rounded">oiac_prayer_times</code> table may not exist yet.
              Create it in the Supabase SQL Editor:
            </p>
            <pre class="bg-red-100 text-red-800 p-3 rounded text-xs overflow-x-auto whitespace-pre-wrap">CREATE TABLE oiac_prayer_times (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  month INT NOT NULL,
  day INT NOT NULL,
  fajr_begins TEXT NOT NULL,
  fajr_jamah TEXT NOT NULL,
  sunrise TEXT NOT NULL,
  zuhr_begins TEXT NOT NULL,
  zuhr_jamah TEXT NOT NULL,
  asr_begins TEXT NOT NULL,
  asr_jamah TEXT NOT NULL,
  maghrib_begins TEXT NOT NULL,
  maghrib_jamah TEXT NOT NULL,
  isha_begins TEXT NOT NULL,
  isha_jamah TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(month, day)
);</pre>
            <button onclick="loadMonth(currentMonth)" class="mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">Retry</button>
          </div>
        `;
      }
    }

    function renderTable() {
      const container = document.getElementById('tableContainer');
      const daysInMonth = DAYS_IN_MONTH[currentMonth];

      // Build lookup by day
      const byDay = {};
      items.forEach(item => { byDay[item.day] = item; });

      let html = `
        <table class="w-full text-sm border-collapse">
          <thead>
            <tr class="bg-gray-100">
              <th class="border px-2 py-2 text-left font-semibold sticky left-0 bg-gray-100 z-10">Day</th>
              ${PRAYER_FIELDS.map(f => `<th class="border px-2 py-2 text-center font-semibold whitespace-nowrap">${f.label}</th>`).join('')}
              <th class="border px-2 py-2 text-center font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (let day = 1; day <= daysInMonth; day++) {
        const existing = byDay[day];
        const rowClass = existing ? '' : 'bg-yellow-50';

        html += `<tr class="${rowClass}" data-day="${day}">`;
        html += `<td class="border px-2 py-1 font-medium sticky left-0 bg-white z-10">${MONTH_NAMES[currentMonth]} ${day}</td>`;

        PRAYER_FIELDS.forEach(f => {
          const value = existing ? (existing[f.key] || '') : '';
          html += `<td class="border px-0 py-0">
            <input type="text" data-day="${day}" data-field="${f.key}"
              value="${escapeAttr(value)}"
              class="w-full px-1 py-1 text-center text-sm border-0 focus:ring-1 focus:ring-blue-500 focus:outline-none"
              style="min-width: 70px;"
              onchange="markEdited(${day})" />
          </td>`;
        });

        html += `<td class="border px-2 py-1 text-center">
          ${existing ? `<button onclick="deleteRow('${existing.id}')" class="text-red-500 hover:text-red-700 text-xs">Del</button>` : ''}
        </td>`;
        html += `</tr>`;
      }

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function escapeAttr(text) {
      if (!text) return '';
      return text.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    window.markEdited = function(day) {
      editedRows[day] = true;
      const row = document.querySelector(`tr[data-day="${day}"]`);
      if (row) row.classList.add('bg-blue-50');
    };

    // Save all edited rows
    async function saveAll() {
      const editedDays = Object.keys(editedRows).map(Number);
      if (editedDays.length === 0) {
        showStatus('No changes to save.', 'info');
        return;
      }

      const records = [];
      for (const day of editedDays) {
        const row = {};
        row.month = currentMonth;
        row.day = day;

        let hasData = false;
        PRAYER_FIELDS.forEach(f => {
          const input = document.querySelector(`input[data-day="${day}"][data-field="${f.key}"]`);
          const val = input ? input.value.trim() : '';
          row[f.key] = val;
          if (val) hasData = true;
        });

        if (hasData) records.push(row);
      }

      if (records.length === 0) {
        showStatus('No valid data to save.', 'warning');
        return;
      }

      const btn = document.getElementById('saveAllBtn');
      btn.textContent = 'Saving...';
      btn.disabled = true;

      try {
        const res = await fetch(API_URL + '?bulk=true', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(records)
        });

        if (!res.ok) throw new Error('Failed to save');
        const result = await res.json();
        showStatus(`Saved ${result.count} prayer time(s).`, 'success');
        editedRows = {};
        await loadMonth(currentMonth);
      } catch (e) {
        showStatus('Error: ' + e.message, 'error');
      } finally {
        btn.textContent = 'Save Month';
        btn.disabled = false;
      }
    }

    // Delete single row
    window.deleteRow = async function(id) {
      if (!confirm('Delete this prayer time entry?')) return;
      try {
        const res = await fetch(API_URL, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        if (!res.ok) throw new Error('Failed to delete');
        await loadMonth(currentMonth);
      } catch (e) { alert('Error: ' + e.message); }
    };

    // Seed from existing JSON files via server-side API
    async function seedFromFiles() {
      if (!confirm('This will import all 365 prayer time entries from the existing JSON files into the database. Continue?')) return;

      const btn = document.getElementById('seedBtn');
      btn.textContent = 'Seeding...';
      btn.disabled = true;

      showStatus('Importing prayer times from content files... This may take a moment.', 'info');

      try {
        const res = await fetch('/api/cms/seed-prayer-times', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to seed');
        }

        const result = await res.json();
        showStatus(`Seeded ${result.count} of ${result.total} prayer time entries.`, 'success');
        await loadMonth(currentMonth);
      } catch (e) {
        showStatus('Seed error: ' + e.message, 'error');
      } finally {
        btn.textContent = 'Seed from Files';
        btn.disabled = false;
      }
    }

    function showStatus(msg, type) {
      const el = document.getElementById('statusMsg');
      el.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800',
        'bg-blue-100', 'text-blue-800', 'bg-yellow-100', 'text-yellow-800');

      const styles = {
        success: 'bg-green-100 text-green-800',
        error: 'bg-red-100 text-red-800',
        info: 'bg-blue-100 text-blue-800',
        warning: 'bg-yellow-100 text-yellow-800',
      };

      el.className = `mb-4 p-3 rounded text-sm ${styles[type] || styles.info}`;
      el.textContent = msg;
    }
  </script>
</AdminLayout>
