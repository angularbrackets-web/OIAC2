---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Jummah Times" currentPage="jummah-times">
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Jummah Times</h1>
      <p class="text-gray-600 mt-1">Manage Friday prayer times displayed on the website</p>
    </div>
    <button id="addNewBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium">
      + Add Jummah Time
    </button>
  </div>

  <!-- Items List -->
  <div id="itemList" class="space-y-4">
    <p class="text-gray-500">Loading...</p>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto mx-4">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">Add Jummah Time</h2>
      <form id="itemForm" class="space-y-4">
        <input type="hidden" id="itemId" />

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
          <input type="text" id="name" required placeholder="e.g. Jummah 1 (Arabic)"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Time *</label>
          <input type="text" id="time" required placeholder="e.g. 12:45 PM"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
          <button type="button" id="cancelBtn" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script is:inline>
    const API_URL = '/api/cms/jummah-times';
    let items = [];

    const SEED_DATA = [
      { name: 'Jummah 1 (Arabic)', time: '12:45 PM', displayOrder: 1 },
      { name: 'Jummah 2 (English)', time: '01:45 PM', displayOrder: 2 },
    ];

    document.addEventListener('DOMContentLoaded', loadItems);

    async function loadItems() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Unknown error');
        }
        items = await response.json();
        renderItems();
      } catch (error) {
        console.error('Error loading jummah times:', error);
        document.getElementById('itemList').innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-6">
            <h3 class="font-semibold text-red-800 mb-2">Could not load jummah times</h3>
            <p class="text-red-600 text-sm mb-3">
              The <code class="bg-red-100 px-1 rounded">oiac_jummah_times</code> table may not exist yet.
              Create it in the Supabase SQL Editor:
            </p>
            <pre class="bg-red-100 text-red-800 p-3 rounded text-xs overflow-x-auto whitespace-pre-wrap">CREATE TABLE oiac_jummah_times (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  time TEXT NOT NULL,
  display_order INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);</pre>
            <button onclick="loadItems()" class="mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">Retry</button>
          </div>
        `;
      }
    }

    function renderItems() {
      const container = document.getElementById('itemList');

      if (items.length === 0) {
        container.innerHTML = `
          <div class="bg-white rounded-lg border-2 border-dashed border-gray-300 p-8 text-center">
            <p class="text-gray-500 mb-2 text-lg font-medium">No jummah times yet</p>
            <p class="text-gray-400 text-sm mb-5">
              Click below to import the existing jummah times from the site.
            </p>
            <button onclick="seedData()" id="seedBtn"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-medium">
              Seed Jummah Times
            </button>
          </div>
        `;
        return;
      }

      container.innerHTML = items.map((item, index) => `
        <div class="bg-white rounded-lg shadow p-4 flex justify-between items-center">
          <div class="flex-1">
            <h3 class="font-semibold text-lg">${escapeHtml(item.name)}</h3>
            <p class="text-gray-500 text-sm">${escapeHtml(item.time)}</p>
          </div>
          <div class="flex gap-2 ml-4">
            <button onclick="moveItem('${item.id}', 'up')" ${index === 0 ? 'disabled' : ''} class="text-gray-600 hover:text-gray-800 px-2 py-1 border border-gray-300 rounded text-sm disabled:opacity-30 disabled:cursor-not-allowed">&#8593;</button>
            <button onclick="moveItem('${item.id}', 'down')" ${index === items.length - 1 ? 'disabled' : ''} class="text-gray-600 hover:text-gray-800 px-2 py-1 border border-gray-300 rounded text-sm disabled:opacity-30 disabled:cursor-not-allowed">&#8595;</button>
            <button onclick="editItem('${item.id}')" class="text-blue-600 hover:text-blue-800 px-3 py-1 border border-blue-600 rounded text-sm">Edit</button>
            <button onclick="deleteItem('${item.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 border border-red-600 rounded text-sm">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Seed
    window.seedData = async function() {
      const btn = document.getElementById('seedBtn');
      btn.textContent = 'Seeding...';
      btn.disabled = true;

      let success = 0;
      for (const item of SEED_DATA) {
        try {
          const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item)
          });
          if (res.ok) success++;
        } catch (e) { console.error('Seed error:', e); }
      }

      if (success > 0) await loadItems();
      else { btn.textContent = 'Seed failed'; btn.disabled = false; }
    };

    // Modal
    const modal = document.getElementById('modal');
    const form = document.getElementById('itemForm');

    document.getElementById('addNewBtn').addEventListener('click', () => {
      document.getElementById('modalTitle').textContent = 'Add Jummah Time';
      form.reset();
      document.getElementById('itemId').value = '';
      showModal();
    });

    document.getElementById('cancelBtn').addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });

    function showModal() { modal.classList.remove('hidden'); modal.classList.add('flex'); }
    function hideModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }

    // Edit
    window.editItem = function(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;

      document.getElementById('modalTitle').textContent = 'Edit Jummah Time';
      document.getElementById('itemId').value = item.id;
      document.getElementById('name').value = item.name;
      document.getElementById('time').value = item.time;
      showModal();
    };

    // Delete
    window.deleteItem = async function(id) {
      if (!confirm('Delete this jummah time?')) return;
      try {
        const res = await fetch(API_URL, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        if (!res.ok) throw new Error('Failed to delete');
        await loadItems();
      } catch (e) { alert('Error: ' + e.message); }
    };

    // Reorder
    window.moveItem = async function(id, direction) {
      const index = items.findIndex(i => i.id === id);
      if (index === -1) return;

      const swapIndex = direction === 'up' ? index - 1 : index + 1;
      if (swapIndex < 0 || swapIndex >= items.length) return;

      const current = items[index];
      const neighbor = items[swapIndex];

      try {
        await Promise.all([
          fetch(API_URL, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: current.id, displayOrder: neighbor.displayOrder })
          }),
          fetch(API_URL, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: neighbor.id, displayOrder: current.displayOrder })
          })
        ]);
        await loadItems();
      } catch (e) { alert('Error: ' + e.message); }
    };

    // Submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('itemId').value;

      const data = {
        name: document.getElementById('name').value,
        time: document.getElementById('time').value,
      };

      try {
        const res = await fetch(API_URL, {
          method: id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(id ? { id, ...data } : data)
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to save');
        }
        hideModal();
        await loadItems();
      } catch (e) { alert('Error: ' + e.message); }
    });
  </script>
</AdminLayout>
