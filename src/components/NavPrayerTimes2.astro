---
import {getJummahTimes, getPrayerTimesForCurrentDay, type JummahTime, type PrayerTime} from '../lib/content/prayer-times'

let prayerTimesForCurrentDay: PrayerTime | undefined;
let jummahTimes: Array<JummahTime> = [];
let hasError = false;

try {
  prayerTimesForCurrentDay = await getPrayerTimesForCurrentDay();
  jummahTimes = await getJummahTimes();

  // If data fetch succeeded but no data found
  if (!prayerTimesForCurrentDay) {
    hasError = true;
  }
} catch (error) {
  console.error('Failed to load prayer times:', error);
  hasError = true;
}

// Note: Next prayer calculation moved to client-side only to avoid timezone issues
// between server (Vercel) and client (user's device)

// Prepare structured data for SEO
const structuredData = prayerTimesForCurrentDay ? {
  "@context": "https://schema.org",
  "@type": "Event",
  "name": "Daily Prayer Times",
  "description": "Islamic prayer times at Omar Ibn Al Khattab Centre",
  "startDate": new Date().toISOString().split('T')[0],
  "location": {
    "@type": "Place",
    "name": "Omar Ibn Al Khattab Centre",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "110 - 1011 Parsons Rd SW",
      "addressLocality": "Edmonton",
      "addressRegion": "AB",
      "postalCode": "T6X 0X2",
      "addressCountry": "CA"
    }
  },
  "organizer": {
    "@type": "Organization",
    "name": "Omar Ibn Al Khattab Centre",
    "url": "https://oiacedmonton.ca"
  },
  "subEvent": [
    {
      "@type": "Event",
      "name": "Fajr Prayer",
      "startDate": `${new Date().toISOString().split('T')[0]}T${prayerTimesForCurrentDay.fajrBegins}`,
      "doorTime": `${new Date().toISOString().split('T')[0]}T${prayerTimesForCurrentDay.fajrJamah}`
    },
    {
      "@type": "Event",
      "name": "Dhuhr Prayer",
      "startDate": `${new Date().toISOString().split('T')[0]}T${prayerTimesForCurrentDay.zuhrBegins}`,
      "doorTime": `${new Date().toISOString().split('T')[0]}T${prayerTimesForCurrentDay.zuhrJamah}`
    },
    {
      "@type": "Event",
      "name": "Asr Prayer",
      "startDate": `${new Date().toISOString().split('T')[0]}T${prayerTimesForCurrentDay.asrBegins}`,
      "doorTime": `${new Date().toISOString().split('T')[0]}T${prayerTimesForCurrentDay.asrJamah}`
    },
    {
      "@type": "Event",
      "name": "Maghrib Prayer",
      "startDate": `${new Date().toISOString().split('T')[0]}T${prayerTimesForCurrentDay.maghribBegins}`,
      "doorTime": `${new Date().toISOString().split('T')[0]}T${prayerTimesForCurrentDay.maghribJamah}`
    },
    {
      "@type": "Event",
      "name": "Isha Prayer",
      "startDate": `${new Date().toISOString().split('T')[0]}T${prayerTimesForCurrentDay.ishaBegins}`,
      "doorTime": `${new Date().toISOString().split('T')[0]}T${prayerTimesForCurrentDay.ishaJamah}`
    }
  ]
} : null;
---

<!-- Structured Data for SEO -->
{structuredData && (
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
)}

<!-- Error State -->
{hasError && (
<section
  class="w-full bg-red-50 border-b border-red-200 sticky top-0 z-40 py-3"
  role="alert"
  aria-live="polite"
>
  <div class="container mx-auto px-4 text-center">
    <p class="text-red-800 text-sm md:text-base">
      <svg class="inline w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
      </svg>
      Unable to load prayer times. Please <button onclick="window.location.reload()" class="underline font-semibold hover:text-red-900">refresh the page</button> or try again later.
    </p>
  </div>
</section>
)}

{!hasError && prayerTimesForCurrentDay && (
<section
  class="w-full bg-warmWhite border-b border-terracottaRed/20 sticky z-40"
  style="top: var(--nav-height, 0px);"
  role="region"
  aria-label="Today's Prayer Times"
>
  <!-- Mobile View -->
  <div class="md:hidden">
    <!-- 5 Daily Prayers -->
    <div class="grid grid-cols-5 gap-1 bg-softBeige-lightest p-1.5">
      <!-- Fajr -->
      <div data-prayer="fajr" class="bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
        <div data-prayer-header class="text-white text-center px-1 py-1.5 text-[10px] font-bold bg-terracottaRed">
          <div>Fajr</div>
          <span data-countdown="fajr" class="block text-[8px] font-normal mt-0.5 hidden">in --</span>
        </div>
        <div class="p-1.5 min-[416px]:p-2 text-center bg-white">
          <time class="block text-[9px] min-[416px]:text-[10px] text-gray-600 font-medium leading-tight whitespace-nowrap">{prayerTimesForCurrentDay.fajrBegins}</time>
          <time class="block text-[11px] min-[416px]:text-xs font-bold text-terracottaRed-darker mt-1 whitespace-nowrap">{prayerTimesForCurrentDay.fajrJamah}</time>
        </div>
      </div>

      <!-- Dhuhr -->
      <div data-prayer="dhuhr" class="bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
        <div data-prayer-header class="text-white text-center px-1 py-1.5 text-[10px] font-bold bg-terracottaRed">
          <div>Dhuhr</div>
          <span data-countdown="dhuhr" class="block text-[8px] font-normal mt-0.5 hidden">in --</span>
        </div>
        <div class="p-1.5 min-[416px]:p-2 text-center bg-white">
          <time class="block text-[9px] min-[416px]:text-[10px] text-gray-600 font-medium leading-tight whitespace-nowrap">{prayerTimesForCurrentDay.zuhrBegins}</time>
          <time class="block text-[11px] min-[416px]:text-xs font-bold text-terracottaRed-darker mt-1 whitespace-nowrap">{prayerTimesForCurrentDay.zuhrJamah}</time>
        </div>
      </div>

      <!-- Asr -->
      <div data-prayer="asr" class="bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
        <div data-prayer-header class="text-white text-center px-1 py-1.5 text-[10px] font-bold bg-terracottaRed">
          <div>Asr</div>
          <span data-countdown="asr" class="block text-[8px] font-normal mt-0.5 hidden">in --</span>
        </div>
        <div class="p-1.5 min-[416px]:p-2 text-center bg-white">
          <time class="block text-[9px] min-[416px]:text-[10px] text-gray-600 font-medium leading-tight whitespace-nowrap">{prayerTimesForCurrentDay.asrBegins}</time>
          <time class="block text-[11px] min-[416px]:text-xs font-bold text-terracottaRed-darker mt-1 whitespace-nowrap">{prayerTimesForCurrentDay.asrJamah}</time>
        </div>
      </div>

      <!-- Maghrib -->
      <div data-prayer="maghrib" class="bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
        <div data-prayer-header class="text-white text-center px-1 py-1.5 text-[10px] font-bold bg-terracottaRed">
          <div>Maghrib</div>
          <span data-countdown="maghrib" class="block text-[8px] font-normal mt-0.5 hidden">in --</span>
        </div>
        <div class="p-1.5 min-[416px]:p-2 text-center bg-white">
          <time class="block text-[9px] min-[416px]:text-[10px] text-gray-600 font-medium leading-tight whitespace-nowrap">{prayerTimesForCurrentDay.maghribBegins}</time>
          <time class="block text-[11px] min-[416px]:text-xs font-bold text-terracottaRed-darker mt-1 whitespace-nowrap">{prayerTimesForCurrentDay.maghribJamah}</time>
        </div>
      </div>

      <!-- Isha -->
      <div data-prayer="isha" class="bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
        <div data-prayer-header class="text-white text-center px-1 py-1.5 text-[10px] font-bold bg-terracottaRed">
          <div>Isha</div>
          <span data-countdown="isha" class="block text-[8px] font-normal mt-0.5 hidden">in --</span>
        </div>
        <div class="p-1.5 min-[416px]:p-2 text-center bg-white">
          <time class="block text-[9px] min-[416px]:text-[10px] text-gray-600 font-medium leading-tight whitespace-nowrap">{prayerTimesForCurrentDay.ishaBegins}</time>
          <time class="block text-[11px] min-[416px]:text-xs font-bold text-terracottaRed-darker mt-1 whitespace-nowrap">{prayerTimesForCurrentDay.ishaJamah}</time>
        </div>
      </div>
    </div>

    <!-- Sunrise & Jummah Times -->
    <div class="grid grid-cols-3 gap-1 bg-softBeige p-1.5">
      <!-- Sunrise -->
      <div class="bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
        <div class="bg-sageGreen text-white text-center py-2 text-[10px] font-bold">
          Sunrise
        </div>
        <div class="p-1.5 min-[416px]:p-2 text-center bg-white">
          <time class="block text-[11px] min-[416px]:text-xs font-bold text-gray-800 whitespace-nowrap">{prayerTimesForCurrentDay.sunrise}</time>
        </div>
      </div>

      <!-- Jummah 1 -->
      <div class="bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
        <div class="bg-sageGreen text-white text-center py-2 text-[10px] font-bold leading-tight">
          {jummahTimes[0]?.name || 'Jummah 1'}
        </div>
        <div class="p-1.5 min-[416px]:p-2 text-center bg-white">
          <time class="block text-[11px] min-[416px]:text-xs font-bold text-gray-800 whitespace-nowrap">{jummahTimes[0]?.time || '02:00 PM'}</time>
        </div>
      </div>

      <!-- Jummah 2 -->
      <div class="bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
        <div class="bg-sageGreen text-white text-center py-2 text-[10px] font-bold leading-tight">
          {jummahTimes[1]?.name || 'Jummah 2'}
        </div>
        <div class="p-1.5 min-[416px]:p-2 text-center bg-white">
          <time class="block text-[11px] min-[416px]:text-xs font-bold text-gray-800 whitespace-nowrap">{jummahTimes[1]?.time || '03:00 PM'}</time>
        </div>
      </div>
    </div>
  </div>

  <!-- Desktop View -->
  <div class="hidden md:block">
    <!-- 5 Daily Prayers -->
    <div class="bg-softBeige-lightest py-1.5 md:py-2">
      <div class="container mx-auto px-4 md:px-6 lg:px-8">
        <div class="flex items-stretch justify-between gap-1 md:gap-1.5">
          <!-- Fajr -->
          <div data-prayer="fajr" class="flex flex-1 min-w-0 bg-white rounded-lg shadow-sm overflow-hidden transition-all border border-terracottaRed/20">
            <div data-prayer-header class="text-white px-2 md:px-3 lg:px-4 py-2 font-bold text-[11px] md:text-xs lg:text-sm xl:text-base flex flex-col items-center justify-center whitespace-nowrap w-[40%] bg-terracottaRed">
              <span>Fajr</span>
              <span data-countdown="fajr" class="text-[8px] md:text-[9px] font-normal mt-1 hidden">in --</span>
            </div>
            <div class="w-[60%] px-2 md:px-3 lg:px-4 py-2 text-center flex flex-col justify-center">
              <time class="block text-[9px] md:text-[10px] lg:text-xs text-gray-600 truncate" title="Adhan (Call to Prayer)">{prayerTimesForCurrentDay.fajrBegins}</time>
              <time class="block text-[11px] md:text-xs lg:text-sm xl:text-base font-bold text-terracottaRed-darker mt-0.5 truncate" title="Iqamah (Congregation)">{prayerTimesForCurrentDay.fajrJamah}</time>
            </div>
          </div>

          <!-- Dhuhr -->
          <div data-prayer="dhuhr" class="flex flex-1 min-w-0 bg-white rounded-lg shadow-sm overflow-hidden transition-all border border-terracottaRed/20">
            <div data-prayer-header class="text-white px-2 md:px-3 lg:px-4 py-2 font-bold text-[11px] md:text-xs lg:text-sm xl:text-base flex flex-col items-center justify-center whitespace-nowrap w-[40%] bg-terracottaRed">
              <span>Dhuhr</span>
              <span data-countdown="dhuhr" class="text-[8px] md:text-[9px] font-normal mt-1 hidden">in --</span>
            </div>
            <div class="w-[60%] px-2 md:px-3 lg:px-4 py-2 text-center flex flex-col justify-center">
              <time class="block text-[9px] md:text-[10px] lg:text-xs text-gray-600 truncate" title="Adhan (Call to Prayer)">{prayerTimesForCurrentDay.zuhrBegins}</time>
              <time class="block text-[11px] md:text-xs lg:text-sm xl:text-base font-bold text-terracottaRed-darker mt-0.5 truncate" title="Iqamah (Congregation)">{prayerTimesForCurrentDay.zuhrJamah}</time>
            </div>
          </div>

          <!-- Asr -->
          <div data-prayer="asr" class="flex flex-1 min-w-0 bg-white rounded-lg shadow-sm overflow-hidden transition-all border border-terracottaRed/20">
            <div data-prayer-header class="text-white px-2 md:px-3 lg:px-4 py-2 font-bold text-[11px] md:text-xs lg:text-sm xl:text-base flex flex-col items-center justify-center whitespace-nowrap w-[40%] bg-terracottaRed">
              <span>Asr</span>
              <span data-countdown="asr" class="text-[8px] md:text-[9px] font-normal mt-1 hidden">in --</span>
            </div>
            <div class="w-[60%] px-2 md:px-3 lg:px-4 py-2 text-center flex flex-col justify-center">
              <time class="block text-[9px] md:text-[10px] lg:text-xs text-gray-600 truncate" title="Adhan (Call to Prayer)">{prayerTimesForCurrentDay.asrBegins}</time>
              <time class="block text-[11px] md:text-xs lg:text-sm xl:text-base font-bold text-terracottaRed-darker mt-0.5 truncate" title="Iqamah (Congregation)">{prayerTimesForCurrentDay.asrJamah}</time>
            </div>
          </div>

          <!-- Maghrib -->
          <div data-prayer="maghrib" class="flex flex-1 min-w-0 bg-white rounded-lg shadow-sm overflow-hidden transition-all border border-terracottaRed/20">
            <div data-prayer-header class="text-white px-2 md:px-3 lg:px-4 py-2 font-bold text-[11px] md:text-xs lg:text-sm xl:text-base flex flex-col items-center justify-center whitespace-nowrap w-[40%] bg-terracottaRed">
              <span>Maghrib</span>
              <span data-countdown="maghrib" class="text-[8px] md:text-[9px] font-normal mt-1 hidden">in --</span>
            </div>
            <div class="w-[60%] px-2 md:px-3 lg:px-4 py-2 text-center flex flex-col justify-center">
              <time class="block text-[9px] md:text-[10px] lg:text-xs text-gray-600 truncate" title="Adhan (Call to Prayer)">{prayerTimesForCurrentDay.maghribBegins}</time>
              <time class="block text-[11px] md:text-xs lg:text-sm xl:text-base font-bold text-terracottaRed-darker mt-0.5 truncate" title="Iqamah (Congregation)">{prayerTimesForCurrentDay.maghribJamah}</time>
            </div>
          </div>

          <!-- Isha -->
          <div data-prayer="isha" class="flex flex-1 min-w-0 bg-white rounded-lg shadow-sm overflow-hidden transition-all border border-terracottaRed/20">
            <div data-prayer-header class="text-white px-2 md:px-3 lg:px-4 py-2 font-bold text-[11px] md:text-xs lg:text-sm xl:text-base flex flex-col items-center justify-center whitespace-nowrap w-[40%] bg-terracottaRed">
              <span>Isha</span>
              <span data-countdown="isha" class="text-[8px] md:text-[9px] font-normal mt-1 hidden">in --</span>
            </div>
            <div class="w-[60%] px-2 md:px-3 lg:px-4 py-2 text-center flex flex-col justify-center">
              <time class="block text-[9px] md:text-[10px] lg:text-xs text-gray-600 truncate" title="Adhan (Call to Prayer)">{prayerTimesForCurrentDay.ishaBegins}</time>
              <time class="block text-[11px] md:text-xs lg:text-sm xl:text-base font-bold text-terracottaRed-darker mt-0.5 truncate" title="Iqamah (Congregation)">{prayerTimesForCurrentDay.ishaJamah}</time>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sunrise & Jummah Times -->
    <div class="bg-softBeige py-1.5">
      <div class="container mx-auto px-4 md:px-6 lg:px-8">
        <div class="flex items-center justify-center gap-2 md:gap-3 lg:gap-4">
          <!-- Sunrise -->
          <div class="flex items-center bg-white rounded-lg border border-sageGreen/30 shadow-sm overflow-hidden">
            <div class="bg-sageGreen text-white px-2 md:px-3 lg:px-4 py-2 font-bold text-[11px] md:text-xs lg:text-sm xl:text-base whitespace-nowrap">
              Sunrise
            </div>
            <div class="px-2 md:px-3 lg:px-4 py-1.5">
              <time class="block text-[11px] md:text-xs lg:text-sm xl:text-base font-bold text-gray-800 whitespace-nowrap">{prayerTimesForCurrentDay.sunrise}</time>
            </div>
          </div>

          <!-- Jummah 1 -->
          <div class="flex items-center bg-white rounded-lg border border-sageGreen/30 shadow-sm overflow-hidden">
            <div class="bg-sageGreen text-white px-2 md:px-3 lg:px-4 py-2 font-bold text-[11px] md:text-xs lg:text-sm xl:text-base whitespace-nowrap">
              {jummahTimes[0]?.name || 'Jummah 1'}
            </div>
            <div class="px-2 md:px-3 lg:px-4 py-1.5">
              <time class="block text-[11px] md:text-xs lg:text-sm xl:text-base font-bold text-gray-800 whitespace-nowrap">{jummahTimes[0]?.time || '02:00 PM'}</time>
            </div>
          </div>

          <!-- Jummah 2 -->
          <div class="flex items-center bg-white rounded-lg border border-sageGreen/30 shadow-sm overflow-hidden">
            <div class="bg-sageGreen text-white px-2 md:px-3 lg:px-4 py-2 font-bold text-[11px] md:text-xs lg:text-sm xl:text-base whitespace-nowrap">
              {jummahTimes[1]?.name || 'Jummah 2'}
            </div>
            <div class="px-2 md:px-3 lg:px-4 py-1.5">
              <time class="block text-[11px] md:text-xs lg:text-sm xl:text-base font-bold text-gray-800 whitespace-nowrap">{jummahTimes[1]?.time || '03:00 PM'}</time>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
)}

<script>
  // Auto-refresh next prayer indicator and countdown
  function updateNextPrayer() {
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    // Helper function to convert time string to minutes
    function timeToMinutes(timeStr: string): number {
      const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
      if (!match) return 0;

      let hours = parseInt(match[1]);
      const minutes = parseInt(match[2]);
      const period = match[3].toUpperCase();

      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;

      return hours * 60 + minutes;
    }

    // Get all prayer cards
    const prayers = [
      { name: 'fajr', displayName: 'Fajr', selector: '[data-prayer="fajr"]' },
      { name: 'dhuhr', displayName: 'Dhuhr', selector: '[data-prayer="dhuhr"]' },
      { name: 'asr', displayName: 'Asr', selector: '[data-prayer="asr"]' },
      { name: 'maghrib', displayName: 'Maghrib', selector: '[data-prayer="maghrib"]' },
      { name: 'isha', displayName: 'Isha', selector: '[data-prayer="isha"]' },
    ];

    let nextPrayerName = '';
    let nextPrayerDisplayName = '';
    let nextPrayerMinutes = 0;

    // Find next prayer by checking time elements
    for (const prayer of prayers) {
      const prayerCard = document.querySelector(prayer.selector);
      if (!prayerCard) continue;

      const timeElement = prayerCard.querySelector('time[title="Iqamah (Congregation)"]');
      if (!timeElement) continue;

      const prayerTime = timeElement.textContent?.trim() || '';
      const prayerMinutes = timeToMinutes(prayerTime);

      if (currentMinutes < prayerMinutes) {
        nextPrayerName = prayer.name;
        nextPrayerDisplayName = prayer.displayName;
        nextPrayerMinutes = prayerMinutes;
        break;
      }
    }

    // If no next prayer found, next is Fajr (tomorrow)
    if (!nextPrayerName) {
      nextPrayerName = 'fajr';
      nextPrayerDisplayName = 'Fajr';

      // Get Fajr time for tomorrow (add 24 hours)
      const fajrCard = document.querySelector('[data-prayer="fajr"]');
      if (fajrCard) {
        const timeElement = fajrCard.querySelector('time[title="Iqamah (Congregation)"]');
        if (timeElement) {
          const fajrTime = timeElement.textContent?.trim() || '';
          nextPrayerMinutes = timeToMinutes(fajrTime) + (24 * 60); // Add 24 hours
        }
      }
    }

    // Update countdown in the next prayer card
    if (nextPrayerMinutes > 0 && nextPrayerName) {
      const minutesUntilPrayer = nextPrayerMinutes - currentMinutes;
      const hours = Math.floor(minutesUntilPrayer / 60);
      const mins = minutesUntilPrayer % 60;

      let countdownText = '';
      if (hours > 0) {
        countdownText = `in ${hours}h ${mins}m`;
      } else {
        countdownText = `in ${mins}m`;
      }

      // Update countdown in all matching cards
      const countdownElements = document.querySelectorAll(`[data-countdown="${nextPrayerName}"]`);
      countdownElements.forEach(el => {
        el.textContent = countdownText;
      });
    }

    // Update UI for all prayers
    prayers.forEach(prayer => {
      const isNext = prayer.name === nextPrayerName;
      const cards = document.querySelectorAll(prayer.selector);

      cards.forEach(card => {
        const header = card.querySelector('[data-prayer-header]');
        const countdown = card.querySelector(`[data-countdown="${prayer.name}"]`);

        if (isNext) {
          // Add highlight classes
          card.classList.remove('border', 'border-terracottaRed/20');
          card.classList.add('border-2', 'border-sageGreen', 'ring-2', 'ring-sageGreen/20');

          if (header) {
            header.classList.remove('bg-terracottaRed');
            header.classList.add('bg-sageGreen');
          }

          if (countdown) {
            countdown.classList.remove('hidden');
          }
        } else {
          // Remove highlight classes
          card.classList.add('border', 'border-terracottaRed/20');
          card.classList.remove('border-2', 'border-sageGreen', 'ring-2', 'ring-sageGreen/20');

          if (header) {
            header.classList.add('bg-terracottaRed');
            header.classList.remove('bg-sageGreen');
          }

          if (countdown) {
            countdown.classList.add('hidden');
          }
        }
      });
    });
  }

  // Run immediately if DOM is ready, otherwise wait for DOMContentLoaded
  function initPrayerTimes() {
    // Run immediately
    updateNextPrayer();

    // Update every 30 seconds for accurate countdown
    setInterval(updateNextPrayer, 30000);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPrayerTimes);
  } else {
    // DOM is already loaded, run immediately
    initPrayerTimes();
  }
</script>
