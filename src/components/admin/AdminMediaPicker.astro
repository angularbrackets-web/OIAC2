---
/**
 * Shared media picker dialog.
 * Opens as a modal to browse/upload media from the Supabase media bucket.
 *
 * Global JS API (available after this component renders):
 *   openMediaPicker(type, onSelect)
 *     type     – 'image' | 'video'
 *     onSelect – callback(url: string) called when user picks a file
 *   closeMediaPicker()
 */
---

<dialog id="media-picker-dialog" class="rounded-xl shadow-2xl backdrop:bg-black/40 p-0 w-full max-w-4xl border border-gray-200 animate-modal-in">
  <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
    <h2 id="media-picker-title" class="text-lg font-semibold text-gray-900">Select Media</h2>
    <button
      type="button"
      id="media-picker-close"
      class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-lg hover:bg-gray-100"
    >
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <!-- Upload area -->
  <div class="px-6 pt-4">
    <label class="flex items-center justify-center gap-2 cursor-pointer rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 hover:bg-blue-50 transition-colors py-4 text-sm text-gray-600 hover:text-blue-600">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
      <span>Upload new file</span>
      <input type="file" id="media-picker-upload" class="hidden" />
    </label>
  </div>

  <!-- Grid -->
  <div class="px-6 py-4 max-h-[60vh] overflow-y-auto">
    <div id="media-picker-grid" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3">
      <p class="col-span-full text-gray-400 text-sm text-center py-8">Loading media...</p>
    </div>
  </div>
</dialog>

<script is:inline>
(function() {
  const MEDIA_API = '/api/cms/media';
  const MAX_FILE_SIZE = 4 * 1024 * 1024;
  let mediaPickerFiles = [];
  let mediaPickerType = 'image';
  let mediaPickerOnSelect = null;

  const dialog = document.getElementById('media-picker-dialog');
  const grid = document.getElementById('media-picker-grid');
  const titleEl = document.getElementById('media-picker-title');
  const closeBtn = document.getElementById('media-picker-close');
  const uploadInput = document.getElementById('media-picker-upload');

  async function loadMedia() {
    try {
      const res = await fetch(MEDIA_API);
      mediaPickerFiles = await res.json();
    } catch (e) {
      mediaPickerFiles = [];
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function renderGrid() {
    const filtered = mediaPickerFiles.filter(f => f.type === mediaPickerType);
    if (filtered.length === 0) {
      grid.innerHTML = `<p class="col-span-full text-gray-400 text-sm text-center py-8">No ${mediaPickerType}s found. Upload one above.</p>`;
      return;
    }
    grid.innerHTML = filtered.map(file => `
      <button type="button" data-media-url="${escapeHtml(file.url)}"
        class="group rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 transition-colors text-left bg-white">
        ${file.type === 'video'
          ? `<div class="aspect-square bg-gray-100 flex items-center justify-center">
               <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-gray-400">
                 <polygon points="5 3 19 12 5 21 5 3"></polygon>
               </svg>
             </div>`
          : `<img src="${escapeHtml(file.url)}" class="aspect-square object-cover w-full" loading="lazy" />`}
        <p class="text-xs px-2 py-1.5 truncate text-gray-600">${escapeHtml(file.name)}</p>
      </button>
    `).join('');
  }

  // Delegation for grid clicks
  grid.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-media-url]');
    if (!btn) return;
    const url = btn.dataset.mediaUrl;
    if (url && mediaPickerOnSelect) {
      mediaPickerOnSelect(url);
    }
    dialog.close();
  });

  closeBtn.addEventListener('click', () => dialog.close());
  dialog.addEventListener('click', (e) => {
    if (e.target === dialog) dialog.close();
  });

  // Upload
  uploadInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > MAX_FILE_SIZE) {
      if (typeof showToast === 'function') {
        showToast('File too large. Max size is 4 MB.', 'error');
      }
      e.target.value = '';
      return;
    }

    const formData = new FormData();
    formData.append('file', file);

    try {
      const res = await fetch(MEDIA_API, { method: 'POST', body: formData });
      if (!res.ok) throw new Error('Upload failed');
      const result = await res.json();
      if (result.url && mediaPickerOnSelect) {
        mediaPickerOnSelect(result.url);
      }
      dialog.close();
    } catch (err) {
      if (typeof showToast === 'function') {
        showToast('Upload failed: ' + err.message, 'error');
      }
    }
    e.target.value = '';
  });

  /**
   * Open the media picker.
   * @param {'image'|'video'} type
   * @param {(url: string) => void} onSelect
   */
  window.openMediaPicker = async function(type, onSelect) {
    mediaPickerType = type || 'image';
    mediaPickerOnSelect = onSelect || null;
    titleEl.textContent = type === 'video' ? 'Select Video' : 'Select Image';

    // Set accepted file types
    uploadInput.accept = type === 'video'
      ? 'video/mp4,video/webm,video/quicktime,.mp4,.webm,.mov'
      : 'image/jpeg,image/png,image/gif,image/webp,image/svg+xml,image/avif,.jpg,.jpeg,.png,.gif,.webp,.svg,.avif';

    grid.innerHTML = '<p class="col-span-full text-gray-400 text-sm text-center py-8">Loading...</p>';
    dialog.showModal();

    await loadMedia();
    renderGrid();
  };

  window.closeMediaPicker = function() {
    dialog.close();
  };
})();
</script>
